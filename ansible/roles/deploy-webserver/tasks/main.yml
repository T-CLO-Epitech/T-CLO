#SPDX-License-Identifier: MIT-0
---
# tasks file for deploy-database
- name: Create directory for app
  file:
    path: /home/{{ ansible_user }}/app
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Archive app locally
  ansible.builtin.command:
    cmd: tar -czf /tmp/sample-app.tar.gz -C .. sample-app-master
  delegate_to: localhost
  run_once: true

- name: Copy app archive to remote
  ansible.builtin.copy:
    src: /tmp/sample-app.tar.gz
    dest: /home/{{ ansible_user }}/app/sample-app.tar.gz
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Extract app archive on remote
  ansible.builtin.unarchive:
    src: /home/{{ ansible_user }}/app/sample-app.tar.gz
    dest: /home/{{ ansible_user }}/app/
    remote_src: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'


- name: Launch Laravel app
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: /home/{{ ansible_user }}/app/sample-app-master

- name: Curl app using VM public IP
  ansible.builtin.command:
    cmd: curl -s -o /dev/null -w "%{http_code}" http://{{ ansible_host }}:8081
  register: curl_output
  retries: 5
  delay: 10
  until: curl_output.stdout == "200"

- name: Debug curl response
  ansible.builtin.debug:
    msg: "HTTP Response: {{ curl_output.stdout }}"

- name: Fail if app did not return 200
  ansible.builtin.fail:
    msg: "App is not healthy! Expected 200, got {{ curl_output.stdout }}"
  when: curl_output.stdout != "200"

