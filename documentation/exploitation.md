# Exploitation

## Mise en place de consul

Avant tout lancement de terraform, un serveur consul doit etre déployer afin de stocker l'état de l'infrastructure (stfate)

### Prérequis

Disposer d'une VM légère.
La VM doit avoir docker installé

Les variables: 

```sh
stateProd: # exemple: terraform/prod
IP: # IP de la machine consule`
YOUR_SUBSCRIPTION_ID: #Id de la souscription azure
```

Ces deux variables vont permettre definir ou seront sotckés les Tfsate dans Consul.

### Procédure

Compier le fichier "docker-compose-consul.yml" sur le serveur

Lancer le serveur:

```sh
docker compose -f docker-compose-consul.yml up --build -d
```

Tester que le serveur est accessible
````sh
curl http://<IP>:8500/v1/kv/<stateProd>
```

## Les secrets AZURE
# Login to Azure
```
az login

# Set your subscription (replace with your Subscription ID)
az account set --subscription <YOUR_SUBSCRIPTION_ID>

# Create a Service Principal
az ad sp create-for-rbac \
  --name "github-actions-terraform" \
  --role="Contributor" \
  --scopes="/subscriptions/<YOUR_SUBSCRIPTION_ID>" \
  --sdk-auth
```

```
{
  "clientId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "clientSecret": "your-client-secret-here",
  "subscriptionId": "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy",
  "tenantId": "zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz",
  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
  "resourceManagerEndpointUrl": "https://management.azure.com/",
  "activeDirectoryGraphResourceId": "https://graph.windows.net/",
  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
  "galleryEndpointUrl": "https://gallery.azure.com/",
  "managementEndpointUrl": "https://management.core.windows.net/"
}
```

Github secret --> AZURE_CREDENTIALS
## Créer un TAG à partir de "main"