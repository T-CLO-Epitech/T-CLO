# Exploitation
### Prérequis
Disposer d'un runner github
Disposer d'une VM légère.
La VM doit avoir docker installé

Disposer/definir les variables suivantes: 

```sh
stateProd: # exemple: terraform/prod
IP: # IP de la machine consul`
YOUR_SUBSCRIPTION_ID: #Id de la souscription azure
```

Disposer également des credentials du compte infiscal: https://app.infisical.com/
Générer deux clefs SSH au format RSA et stocker les dans ce Vault

## Mise en place de consul

Avant tout lancement de terraform, un serveur consul doit etre déployer afin de stocker l'état de l'infrastructure (stfate)

### Procédure

Compier le fichier "docker-compose-consul.yml" sur le serveur

Lancer le serveur:

```sh
docker compose -f docker-compose-consul.yml up --build -d
```

Tester que le serveur est accessible
```sh
curl http://<IP>:8500/v1/kv/?keys
```

## Les secrets AZURE

### Récuperer les secrets

```sh
az login

# Set your subscription (replace with your Subscription ID)
az account set --subscription <YOUR_SUBSCRIPTION_ID>

# Create a Service Principal
az ad sp create-for-rbac \
  --name "github-actions-terraform" \
  --role="Contributor" \
  --scopes="/subscriptions/<YOUR_SUBSCRIPTION_ID>" \
  --sdk-auth
```
L'output de cette commande devra être ajouter dans les secret github au chapitre suivant.
exemple de l'output:
```
{
  "clientId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "clientSecret": "your-client-secret-here",
  "subscriptionId": "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy",
  "tenantId": "zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz",
  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
  "resourceManagerEndpointUrl": "https://management.azure.com/",
  "activeDirectoryGraphResourceId": "https://graph.windows.net/",
  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
  "galleryEndpointUrl": "https://gallery.azure.com/",
  "managementEndpointUrl": "https://management.core.windows.net/"
}
```
## Ajouter les secret pour la CI

Rendez vous dans les secret du repository, et ajouter les variables suivantes:

AZURE_CREDENTIALS # l'output du chapitre précédent
CI_SSH_KEY #La clef ssh de dev (format RSA) stockée dans infiscale
CI_SSH_KEY_PROD # La clef ssh de production (format RSA) stockée dans infiscale 

## Créer un TAG à partir de "main"